<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÜ Valkey Serverless Leaderboard</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: white; }
        .container { max-width: 1000px; margin: 0 auto; background: rgba(255,255,255,0.1); border-radius: 20px; backdrop-filter: blur(10px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #ff6b6b, #feca57); padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .badge { background: #4CAF50; color: white; padding: 8px 20px; border-radius: 25px; font-size: 0.9em; font-weight: bold; display: inline-block; margin: 5px; }
        .github-badge { background: #2196F3; }
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; padding: 30px; }
        .section { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 25px; backdrop-filter: blur(5px); }
        .section h3 { margin-bottom: 20px; font-size: 1.3em; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; background: rgba(255,255,255,0.9); color: #333; }
        .btn { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; margin-bottom: 10px; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-secondary { background: linear-gradient(135deg, #ff6b6b, #ff5252); }
        .message { padding: 15px; border-radius: 8px; margin: 15px 0; font-weight: 500; }
        .message.success { background: rgba(76, 175, 80, 0.2); border: 1px solid #4CAF50; color: #4CAF50; }
        .message.error { background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; color: #f44336; }
        .message.info { background: rgba(33, 150, 243, 0.2); border: 1px solid #2196F3; color: #2196F3; }
        .message.warning { background: rgba(255, 193, 7, 0.2); border: 1px solid #ffc107; color: #ffc107; }
        .leaderboard { grid-column: 1 / -1; background: rgba(255,255,255,0.1); border-radius: 15px; padding: 25px; backdrop-filter: blur(5px); }
        .leaderboard h3 { margin-bottom: 20px; font-size: 1.5em; }
        .leaderboard-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; background: rgba(255,255,255,0.1); border-radius: 10px; border-left: 4px solid #667eea; }
        .leaderboard-item:nth-child(1) { border-left-color: #ffd700; }
        .leaderboard-item:nth-child(2) { border-left-color: #c0c0c0; }
        .leaderboard-item:nth-child(3) { border-left-color: #cd7f32; }
        .rank { font-size: 1.2em; font-weight: bold; color: #667eea; min-width: 40px; }
        .player-name { flex-grow: 1; font-weight: 600; margin-left: 15px; }
        .score { font-size: 1.1em; font-weight: bold; color: #4CAF50; }
        .cors-notice { background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        .deployment-steps { background: rgba(33, 150, 243, 0.2); border: 1px solid #2196F3; padding: 20px; border-radius: 10px; margin-top: 15px; }
        .deployment-steps h4 { color: #2196F3; margin-bottom: 10px; }
        .deployment-steps ol { text-align: left; padding-left: 20px; }
        .deployment-steps li { margin-bottom: 8px; }
        @media (max-width: 768px) { .main-content { grid-template-columns: 1fr; gap: 20px; padding: 20px; } .header h1 { font-size: 2em; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ Valkey Serverless Leaderboard</h1>
            <div class="badge">üî¥ LIVE</div>
            <div class="badge">üìù POST ENABLED</div>
            <div class="badge github-badge">üöÄ GITHUB PAGES READY</div>
            <p>Real-time gaming leaderboard powered by AWS Lambda & Valkey Serverless</p>
            <div class="deployment-steps">
                <h4>üöÄ Deploy to GitHub Pages for Full Functionality</h4>
                <ol>
                    <li>Push this <code>index.html</code> to your GitHub repository</li>
                    <li>Go to repository Settings ‚Üí Pages</li>
                    <li>Select "Deploy from a branch" ‚Üí main/master</li>
                    <li>Access via <code>https://username.github.io/repo-name</code></li>
                    <li>Full POST/GET functionality will work from HTTPS!</li>
                </ol>
            </div>
        </div>

        <div class="cors-notice" id="corsNotice">
            <h4>üåê CORS Notice</h4>
            <p><strong>Currently viewing from local file (file://) - Limited functionality</strong><br>
            Upload to GitHub Pages, Netlify, or any web server for full functionality!</p>
        </div>
        
        <div class="main-content">
            <div class="section">
                <h3>üéÆ Add Your Score</h3>
                <form id="scoreForm">
                    <div class="form-group">
                        <label for="playerName">Player Name</label>
                        <input type="text" id="playerName" placeholder="Enter your name" required>
                    </div>
                    <div class="form-group">
                        <label for="playerScore">Score</label>
                        <input type="number" id="playerScore" placeholder="Enter your score" required min="1" value="1500">
                    </div>
                    <button type="submit" class="btn" id="submitBtn">üöÄ Submit to Valkey</button>
                </form>
                <div id="scoreMessage"></div>
            </div>
            
            <div class="section">
                <h3>‚ö° Real-Time Actions</h3>
                <button class="btn" onclick="testConnection()">üîç Test Connection</button>
                <button class="btn" onclick="refreshLeaderboard()">üîÑ Refresh Leaderboard</button>
                <button class="btn btn-secondary" onclick="showAPICommands()">üìñ Show API Commands</button>
                <div id="actionMessage"></div>
            </div>
            
            <div class="leaderboard">
                <h3>üèÖ Live Leaderboard</h3>
                <div id="leaderboardList">
                    <div class="message info">Upload to GitHub Pages to see live data from Valkey Serverless!</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://u3ry7t6rah.execute-api.us-west-2.amazonaws.com';
        let isLocalFile = window.location.protocol === 'file:';

        function showMessage(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => { if (type !== 'loading') element.innerHTML = ''; }, 5000);
        }

        // Enhanced API call with CORS handling
        async function apiCall(endpoint, method = 'GET', body = null) {
            const cacheBuster = `?t=${Date.now()}&r=${Math.random().toString(36).substring(7)}`;
            
            try {
                const options = {
                    method: method,
                    mode: 'cors',
                    credentials: 'omit',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                };

                if (body) options.body = JSON.stringify(body);

                const response = await fetch(API_BASE_URL + endpoint + cacheBuster, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                // Hide CORS notice if successful
                if (document.getElementById('corsNotice')) {
                    document.getElementById('corsNotice').style.display = 'none';
                }
                
                return data;
                
            } catch (error) {
                // Show CORS notice if failed
                if (isLocalFile && document.getElementById('corsNotice')) {
                    document.getElementById('corsNotice').style.display = 'block';
                }
                throw error;
            }
        }

        async function testConnection() {
            showMessage('actionMessage', 'Testing connection to Valkey Serverless...', 'info');
            try {
                const data = await apiCall('/health');
                if (data.success && data.ping === 'PONG') {
                    const cacheStatus = data.cache_disabled ? 'DISABLED' : 'ENABLED';
                    showMessage('actionMessage', `‚úÖ Connected! Ping: ${data.ping}, Cache: ${cacheStatus}`, 'success');
                    return true;
                } else {
                    showMessage('actionMessage', '‚ùå Unexpected response from Valkey', 'error');
                    return false;
                }
            } catch (error) {
                if (isLocalFile) {
                    showMessage('actionMessage', '‚ö†Ô∏è CORS Error: Please upload to GitHub Pages for full functionality', 'warning');
                } else {
                    showMessage('actionMessage', `‚ùå Connection failed: ${error.message}`, 'error');
                }
                return false;
            }
        }

        async function refreshLeaderboard() {
            showMessage('actionMessage', 'Loading fresh data from Valkey...', 'info');
            try {
                const data = await apiCall('/leaderboard');
                displayLeaderboard(data.leaderboard);
                showMessage('actionMessage', `‚úÖ Leaderboard refreshed! ${data.leaderboard.length} players loaded`, 'success');
            } catch (error) {
                if (isLocalFile) {
                    showMessage('actionMessage', '‚ö†Ô∏è CORS Error: Upload to GitHub Pages to see live data', 'warning');
                } else {
                    showMessage('actionMessage', `‚ùå Failed to load leaderboard: ${error.message}`, 'error');
                }
            }
        }

        function displayLeaderboard(leaderboard) {
            const list = document.getElementById('leaderboardList');
            
            if (!leaderboard || leaderboard.length === 0) {
                list.innerHTML = '<div class="message info">No players yet. Be the first to add your score!</div>';
                return;
            }
            
            list.innerHTML = leaderboard.map((player, index) => `
                <div class="leaderboard-item">
                    <span class="rank">#${index + 1}</span>
                    <span class="player-name">${player.player}</span>
                    <span class="score">${player.score.toLocaleString()}</span>
                </div>
            `).join('');
        }

        function showAPICommands() {
            showMessage('actionMessage', `
                <strong>üìñ API Commands (work from terminal):</strong><br><br>
                <strong>Health Check:</strong><br>
                <code>curl ${API_BASE_URL}/health</code><br><br>
                <strong>Get Leaderboard:</strong><br>
                <code>curl ${API_BASE_URL}/leaderboard</code><br><br>
                <strong>Add Score:</strong><br>
                <code>curl -X POST ${API_BASE_URL}/score -H "Content-Type: application/json" -d '{"player":"YourName","score":1000}'</code>
            `, 'info');
        }

        // Form submission
        document.getElementById('scoreForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const playerName = document.getElementById('playerName').value.trim();
            const playerScore = parseInt(document.getElementById('playerScore').value);
            const submitBtn = document.getElementById('submitBtn');
            
            if (!playerName || isNaN(playerScore) || playerScore < 1) {
                showMessage('scoreMessage', '‚ùå Please enter valid player name and score', 'error');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Submitting...';
            showMessage('scoreMessage', 'Submitting score to Valkey Serverless...', 'info');
            
            try {
                const data = await apiCall('/score', 'POST', {
                    player: playerName,
                    score: playerScore
                });
                
                if (data.success) {
                    showMessage('scoreMessage', `‚úÖ ${data.message} - Added to Valkey!`, 'success');
                    document.getElementById('scoreForm').reset();
                    document.getElementById('playerScore').value = '1500';
                    setTimeout(() => refreshLeaderboard(), 1000);
                } else {
                    showMessage('scoreMessage', `‚ùå ${data.error || 'Submission failed'}`, 'error');
                }
            } catch (error) {
                if (isLocalFile) {
                    showMessage('scoreMessage', '‚ö†Ô∏è CORS Error: Upload to GitHub Pages for POST functionality', 'warning');
                } else {
                    showMessage('scoreMessage', `‚ùå Failed to submit score: ${error.message}`, 'error');
                }
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'üöÄ Submit to Valkey';
            }
        });

        // Initialize
        window.addEventListener('load', () => {
            if (isLocalFile) {
                console.log('‚ö†Ô∏è Running from local file - upload to GitHub Pages for full functionality');
                document.getElementById('corsNotice').style.display = 'block';
            } else {
                console.log('‚úÖ Running from web server - full functionality available');
                document.getElementById('corsNotice').style.display = 'none';
                testConnection().then(connected => {
                    if (connected) refreshLeaderboard();
                });
            }
        });

        console.log(`
üèÜ Valkey Serverless Leaderboard - GitHub Pages Ready

üöÄ To enable full functionality:
   1. Upload this index.html to GitHub repository
   2. Enable GitHub Pages in repository settings
   3. Access via https://username.github.io/repo-name
   4. Full POST/GET operations will work from HTTPS!

üîß API Endpoint: ${API_BASE_URL}
üí° Current Status: ${isLocalFile ? 'Local file (limited)' : 'Web server (full functionality)'}
        `);
    </script>
</body>
</html>
