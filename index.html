<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÜ Valkey Serverless Leaderboard - Direct API Gateway</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .live-badge {
            background: #4CAF50;
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: bold;
            display: inline-block;
            margin: 5px;
            animation: pulse 2s infinite;
        }
        .direct-badge {
            background: #2196F3;
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: bold;
            display: inline-block;
            margin: 5px;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
        }
        .success { background: rgba(76, 175, 80, 0.8); }
        .error { background: rgba(244, 67, 54, 0.8); }
        .loading { background: rgba(255, 152, 0, 0.8); }
        .warning { background: rgba(255, 193, 7, 0.8); color: black; }
        .info { background: rgba(33, 150, 243, 0.8); }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .section {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(5px);
        }
        
        .section h3 {
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        
        button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 8px 5px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        button:disabled { 
            background: #666; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }
        
        input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            color: black;
            box-sizing: border-box;
        }
        
        .leaderboard {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(5px);
        }
        .leaderboard h3 {
            margin-bottom: 20px;
            font-size: 1.5em;
            text-align: center;
        }
        .player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 8px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
        }
        .player:hover {
            transform: translateX(5px);
        }
        .player:nth-child(1) { border-left-color: #ffd700; background: rgba(255, 215, 0, 0.2); }
        .player:nth-child(2) { border-left-color: #c0c0c0; background: rgba(192, 192, 192, 0.2); }
        .player:nth-child(3) { border-left-color: #cd7f32; background: rgba(205, 127, 50, 0.2); }
        
        .rank {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffd700;
            min-width: 40px;
        }
        .player-name {
            flex-grow: 1;
            font-weight: 600;
            margin-left: 15px;
        }
        .score {
            font-size: 1.1em;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .debug {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            display: block;
            color: #4CAF50;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .cors-fix {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(33, 150, 243, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            color: #e3f2fd;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ Valkey Serverless Leaderboard</h1>
            <div class="live-badge">üî¥ LIVE</div>
            <div class="direct-badge">üéØ Direct API</div>
            <div class="live-badge">‚òÅÔ∏è AWS</div>
            <p><strong>API:</strong> https://u3ry7t6rah.execute-api.us-west-2.amazonaws.com</p>
        </div>
        
        <div id="status" class="status loading">üîÑ Connecting to Valkey Serverless...</div>
        
        <div class="cors-fix">
            <strong>üéØ Direct API Gateway Connection!</strong><br>
            This version tries to connect directly to your API Gateway first. If CORS is properly configured, 
            it will work without any proxy. Falls back to proxy only if direct connection fails.
        </div>
        
        <div class="main-content">
            <div class="section">
                <h3>üéÆ Add Your Score</h3>
                <input type="text" id="playerName" placeholder="Player Name" />
                <input type="number" id="playerScore" placeholder="Score" />
                <button onclick="addScore()" id="addScoreBtn">üöÄ Add Score Directly</button>
                <div id="scoreMessage"></div>
            </div>
            
            <div class="section">
                <h3>‚ö° Actions</h3>
                <button onclick="testHealth()">üîç Test Connection</button>
                <button onclick="loadLeaderboard()">üîÑ Refresh Leaderboard</button>
                
                <div class="stats">
                    <div class="stat-card">
                        <span class="stat-number" id="totalPlayers">-</span>
                        <span class="stat-label">Players</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="topScore">-</span>
                        <span class="stat-label">Top Score</span>
                    </div>
                </div>
                
                <div id="actionMessage"></div>
            </div>
        </div>
        
        <div class="leaderboard">
            <h3>üèÖ Live Leaderboard (Real Valkey Data)</h3>
            <div id="leaderboard">Loading real data from Valkey Serverless...</div>
        </div>
        
        <div class="debug">
            <strong>üîß Debug Information:</strong><br>
            <div id="debug">Initializing connection...</div>
        </div>
    </div>

    <script>
        const API_URL = 'https://u3ry7t6rah.execute-api.us-west-2.amazonaws.com';
        let debugLog = [];
        let usingProxy = false;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.push(`${timestamp}: ${message}`);
            document.getElementById('debug').innerHTML = debugLog.slice(-10).join('<br>');
            console.log(message);
        }

        function setStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            log(`Status: ${message}`);
        }

        function showMessage(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}" style="margin: 10px 0; padding: 10px; font-size: 14px;">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 8000);
        }

        // Try direct API Gateway first, then fallback to proxy
        async function apiRequest(endpoint, options = {}) {
            const url = API_URL + endpoint;
            log(`Making ${options.method || 'GET'} request to ${endpoint}`);
            
            try {
                // Try direct API Gateway connection first
                log('üéØ Attempting direct API Gateway connection...');
                const response = await fetch(url, {
                    method: options.method || 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    body: options.body ? JSON.stringify(options.body) : undefined
                });
                
                log(`Direct response status: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Direct API Gateway connection successful!');
                    if (usingProxy) {
                        usingProxy = false;
                        log('üéØ Switched back to direct connection');
                    }
                    return data;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (directError) {
                log(`‚ùå Direct connection failed: ${directError.message}`);
                
                // Fallback to CORS proxy
                return await proxyRequest(endpoint, options);
            }
        }

        // CORS proxy fallback
        async function proxyRequest(endpoint, options = {}) {
            log('üîÑ Falling back to CORS proxy...');
            usingProxy = true;
            
            try {
                if (options.method === 'POST') {
                    // For POST requests, try cors-anywhere first
                    const proxyUrl = `https://cors-anywhere.herokuapp.com/${API_URL}${endpoint}`;
                    log(`Using CORS proxy: ${proxyUrl}`);
                    
                    const response = await fetch(proxyUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify(options.body)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        log('‚úÖ CORS proxy POST successful');
                        return data;
                    } else {
                        throw new Error(`Proxy error: ${response.status}`);
                    }
                } else {
                    // For GET requests, use allorigins
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(API_URL + endpoint)}`;
                    log(`Using GET proxy: ${proxyUrl}`);
                    
                    const response = await fetch(proxyUrl);
                    if (response.ok) {
                        const data = await response.json();
                        log('‚úÖ CORS proxy GET successful');
                        return data;
                    } else {
                        throw new Error(`Proxy error: ${response.status}`);
                    }
                }
            } catch (proxyError) {
                log(`‚ùå CORS proxy also failed: ${proxyError.message}`);
                throw new Error('Both direct and proxy connections failed');
            }
        }

        async function testHealth() {
            setStatus('üîÑ Testing connection to Valkey...', 'loading');
            try {
                const data = await apiRequest('/health');
                if (data && data.success && data.ping === 'PONG') {
                    const connectionType = usingProxy ? 'via CORS proxy' : 'directly';
                    setStatus(`‚úÖ Connected to Valkey Serverless ${connectionType}! Ping: ${data.ping}`, 'success');
                    return true;
                } else {
                    setStatus('‚ùå Unexpected response from Valkey', 'error');
                    return false;
                }
            } catch (error) {
                setStatus(`‚ùå Connection failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function loadLeaderboard() {
            setStatus('üîÑ Loading leaderboard from Valkey...', 'loading');
            try {
                const data = await apiRequest('/leaderboard');
                if (data && data.leaderboard) {
                    displayLeaderboard(data.leaderboard);
                    updateStats(data.leaderboard);
                    const connectionType = usingProxy ? 'via proxy' : 'directly';
                    setStatus(`‚úÖ Loaded ${data.leaderboard.length} players ${connectionType}`, 'success');
                } else {
                    throw new Error('Invalid leaderboard data');
                }
            } catch (error) {
                setStatus(`‚ùå Failed to load leaderboard: ${error.message}`, 'error');
                document.getElementById('leaderboard').innerHTML = `<div class="status error">Error loading leaderboard: ${error.message}</div>`;
            }
        }

        async function addScore() {
            const name = document.getElementById('playerName').value.trim();
            const score = parseInt(document.getElementById('playerScore').value);
            const btn = document.getElementById('addScoreBtn');
            
            if (!name || isNaN(score)) {
                showMessage('scoreMessage', '‚ùå Please enter valid name and score', 'error');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Adding Score...';
            setStatus('üîÑ Adding score to Valkey...', 'loading');
            
            try {
                const data = await apiRequest('/score', {
                    method: 'POST',
                    body: { player: name, score: score }
                });
                
                if (data && data.success) {
                    const connectionType = usingProxy ? 'via proxy' : 'directly';
                    showMessage('scoreMessage', `‚úÖ ${data.message} (${connectionType})`, 'success');
                    setStatus(`‚úÖ Score added successfully ${connectionType}!`, 'success');
                    
                    // Clear form
                    document.getElementById('playerName').value = '';
                    document.getElementById('playerScore').value = '';
                    
                    // Refresh leaderboard after a short delay
                    setTimeout(async () => {
                        await loadLeaderboard();
                    }, 1000);
                } else {
                    showMessage('scoreMessage', `‚ùå ${data ? data.error : 'Unknown error'}`, 'error');
                    setStatus('‚ùå Failed to add score', 'error');
                }
            } catch (error) {
                showMessage('scoreMessage', `‚ùå Error: ${error.message}`, 'error');
                setStatus(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Add Score Directly';
            }
        }

        function updateStats(players) {
            document.getElementById('totalPlayers').textContent = players.length;
            document.getElementById('topScore').textContent = players.length > 0 ? players[0].score.toLocaleString() : '0';
        }

        function displayLeaderboard(players) {
            const leaderboardDiv = document.getElementById('leaderboard');
            if (!players || players.length === 0) {
                leaderboardDiv.innerHTML = '<div class="status info">No players yet! Be the first to add your score.</div>';
                return;
            }
            
            leaderboardDiv.innerHTML = players.map((player, index) => `
                <div class="player">
                    <span class="rank">#${index + 1}</span>
                    <span class="player-name">${player.player}</span>
                    <span class="score">${player.score.toLocaleString()}</span>
                </div>
            `).join('');
        }

        // Initialize the app
        window.addEventListener('load', async () => {
            log('üöÄ Valkey Serverless Leaderboard starting with direct API Gateway...');
            
            // Test connection and load leaderboard
            const healthOk = await testHealth();
            if (healthOk) {
                await loadLeaderboard();
                
                // Auto-refresh leaderboard every 30 seconds
                setInterval(async () => {
                    try {
                        await loadLeaderboard();
                    } catch (error) {
                        log(`Auto-refresh failed: ${error.message}`);
                    }
                }, 30000);
                
                log('‚úÖ Auto-refresh enabled (every 30 seconds)');
            } else {
                log('‚ùå Initial connection failed');
            }
        });
    </script>
</body>
</html>
