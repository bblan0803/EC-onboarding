<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Leaderboard - Powered by Amazon ElastiCache Serverless for Valkey 8.1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            background: linear-gradient(135deg, #58cc02 0%, #89e219 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 24px;
            box-shadow: 0 24px 48px rgba(0,0,0,0.12);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1cb0f6 0%, #58cc02 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
            animation: float 20s linear infinite;
        }
        
        @keyframes float {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .header h1 {
            font-size: 2.8em;
            margin-bottom: 12px;
            font-weight: 800;
            position: relative;
            z-index: 1;
        }
        
        .demo-badge {
            background: rgba(255,255,255,0.25);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 0.95em;
            font-weight: 700;
            display: inline-block;
            margin: 8px 5px;
            border: 2px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }
        
        .live-badge {
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: bold;
            display: inline-block;
            margin: 5px;
            animation: pulse 2s infinite;
            position: relative;
            z-index: 1;
        }
        
        .direct-badge {
            background: #2196F3;
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: bold;
            display: inline-block;
            margin: 5px;
            position: relative;
            z-index: 1;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .header p {
            margin-top: 12px;
            font-size: 1.1em;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }
        
        .status {
            padding: 16px 20px;
            margin: 20px;
            border-radius: 12px;
            font-weight: 600;
            text-align: center;
            border: 2px solid transparent;
        }
        
        .status.loading {
            background: linear-gradient(135deg, #cce7ff 0%, #e6f3ff 100%);
            color: #004085;
            border-color: #1cb0f6;
        }
        
        .status.success {
            background: linear-gradient(135deg, #d4edda 0%, #e8f5e8 100%);
            color: #155724;
            border-color: #58cc02;
        }
        
        .status.error {
            background: linear-gradient(135deg, #f8d7da 0%, #fce8ea 100%);
            color: #721c24;
            border-color: #ff4757;
        }
        
        .status.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #fef9e7 100%);
            color: #856404;
            border-color: #ffc107;
        }
        
        .cors-fix {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(33, 150, 243, 0.5);
            padding: 20px;
            border-radius: 16px;
            margin: 20px;
            color: #1565c0;
            font-weight: 600;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            padding: 32px;
        }
        
        .section {
            background: #ffffff;
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.06);
            border: 2px solid #f7f7f7;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .section:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.1);
        }
        
        .section h3 {
            color: #3c3c3c;
            margin-bottom: 24px;
            font-size: 1.6em;
            font-weight: 700;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4b4b4b;
            font-size: 0.95em;
        }
        
        input {
            width: 100%;
            padding: 16px 20px;
            border: 3px solid #e5e5e5;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s ease;
            background: #fafafa;
        }
        
        input:focus {
            outline: none;
            border-color: #1cb0f6;
            background: #ffffff;
            transform: scale(1.02);
        }
        
        input:valid {
            border-color: #58cc02;
        }
        
        .btn {
            background: linear-gradient(135deg, #58cc02 0%, #89e219 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(88, 204, 2, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(88, 204, 2, 0.4);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #1cb0f6 0%, #00b4d8 100%);
            box-shadow: 0 4px 12px rgba(28, 176, 246, 0.3);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 8px 20px rgba(28, 176, 246, 0.4);
        }
        
        .leaderboard {
            grid-column: 1 / -1;
        }
        
        .leaderboard-list {
            list-style: none;
            margin-top: 24px;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f8ff 100%);
            border-radius: 16px;
            border-left: 6px solid #1cb0f6;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .leaderboard-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(88, 204, 2, 0.05) 0%, rgba(28, 176, 246, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .leaderboard-item:hover {
            transform: translateX(8px) scale(1.02);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }
        
        .leaderboard-item:hover::before {
            opacity: 1;
        }
        
        .leaderboard-item:nth-child(1) { 
            border-left-color: #ffd700; 
            background: linear-gradient(135deg, #fff9e6 0%, #fffbf0 100%);
        }
        .leaderboard-item:nth-child(2) { 
            border-left-color: #c0c0c0; 
            background: linear-gradient(135deg, #f5f5f5 0%, #fafafa 100%);
        }
        .leaderboard-item:nth-child(3) { 
            border-left-color: #cd7f32; 
            background: linear-gradient(135deg, #fff4e6 0%, #fff8f0 100%);
        }
        
        .rank {
            font-size: 1.4em;
            font-weight: 800;
            color: #1cb0f6;
            min-width: 40px;
            position: relative;
            z-index: 1;
        }
        
        .leaderboard-item:nth-child(1) .rank { color: #ffd700; }
        .leaderboard-item:nth-child(2) .rank { color: #c0c0c0; }
        .leaderboard-item:nth-child(3) .rank { color: #cd7f32; }
        
        .player-name {
            flex-grow: 1;
            font-weight: 700;
            color: #2c2c2c;
            margin-left: 20px;
            font-size: 1.1em;
            position: relative;
            z-index: 1;
        }
        
        .score {
            font-size: 1.3em;
            font-weight: 800;
            color: #58cc02;
            position: relative;
            z-index: 1;
        }
        
        .message {
            padding: 16px 20px;
            border-radius: 12px;
            margin-top: 16px;
            font-weight: 600;
            border: 2px solid transparent;
        }
        
        .message.success {
            background: linear-gradient(135deg, #d4edda 0%, #e8f5e8 100%);
            color: #155724;
            border-color: #58cc02;
        }
        
        .message.error {
            background: linear-gradient(135deg, #f8d7da 0%, #fce8ea 100%);
            color: #721c24;
            border-color: #ff4757;
        }
        
        .message.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #fef9e7 100%);
            color: #856404;
            border-color: #ffc107;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        
        .stat-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: transform 0.2s ease;
        }
        
        .stat-item:hover {
            transform: translateY(-2px);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 800;
            color: #58cc02;
        }
        
        .stat-label {
            color: #6c757d;
            font-weight: 600;
            margin-top: 8px;
        }
        
        .tech-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid #e9ecef;
            border-radius: 20px;
            padding: 28px;
            margin-top: 24px;
            grid-column: 1 / -1;
        }
        
        .tech-info h3 {
            color: #495057;
            margin-bottom: 20px;
            font-weight: 700;
            font-size: 1.3em;
        }
        
        .tech-stack {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }
        
        .tech-item {
            background: #ffffff;
            padding: 20px;
            border-radius: 16px;
            border-left: 4px solid #58cc02;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .tech-item:hover {
            transform: translateY(-2px);
        }
        
        .tech-item strong {
            color: #58cc02;
            font-weight: 700;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 24px;
                padding: 24px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .tech-stack {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° Real-time Leaderboard</h1>
            <div class="demo-badge">üöÄ Powered by Amazon ElastiCache Serverless for Valkey 8.1</div>
            <div class="live-badge">üî¥ LIVE</div>
            <div class="direct-badge">üéØ Direct API</div>
            <div class="live-badge">‚òÅÔ∏è AWS</div>
            <p>Real-time gaming leaderboard with serverless architecture</p>
        </div>

        <div id="status" class="status loading">üîÑ Connecting to Valkey Serverless...</div>

        <div class="cors-fix">
            <strong>üéØ Direct API Gateway Connection!</strong><br>
            This version tries to connect directly to your API Gateway first. If CORS is properly configured, 
            it will work without any proxy. Falls back to proxy only if direct connection fails.
        </div>

        <div class="main-content">
            <div class="section">
                <h3>üéÆ Add Your Score</h3>
                <form id="scoreForm">
                    <div class="form-group">
                        <label for="playerName">Player Name</label>
                        <input type="text" id="playerName" placeholder="Enter your name" required maxlength="20">
                    </div>
                    <div class="form-group">
                        <label for="playerScore">Score (Max: 1000)</label>
                        <input type="number" id="playerScore" placeholder="Enter your score" required min="0" max="1000">
                    </div>
                    <button type="submit" class="btn" id="addScoreBtn">üöÄ Add Score Directly</button>
                </form>
                <div id="scoreMessage"></div>
            </div>

            <div class="section">
                <h3>‚ö° Quick Actions</h3>
                <button class="btn btn-secondary" onclick="loadLeaderboard()">üîÑ Refresh Leaderboard</button>
                <button class="btn btn-secondary" onclick="testHealth()">üè• Test Connection</button>
            </div>

            <div class="section leaderboard">
                <h3>üèÖ Live Leaderboard (Real Valkey Data)</h3>
                <ul id="leaderboard"></ul>
                <div class="stats" id="stats"></div>
            </div>

            <div class="tech-info">
                <h3>üõ†Ô∏è Technology Stack</h3>
                <div class="tech-stack">
                    <div class="tech-item">
                        <strong>Frontend:</strong><br>
                        Modern HTML5, CSS3, Vanilla JavaScript
                    </div>
                    <div class="tech-item">
                        <strong>Backend:</strong><br>
                        AWS Lambda (Python 3.9)
                    </div>
                    <div class="tech-item">
                        <strong>Database:</strong><br>
                        Amazon ElastiCache Serverless for Valkey
                    </div>
                    <div class="tech-item">
                        <strong>Infrastructure:</strong><br>
                        AWS VPC, Security Groups, TLS
                    </div>
                </div>
                <div class="message success" style="margin-top: 20px;">
                    <strong>üèóÔ∏è Live Architecture:</strong> This application connects to real AWS infrastructure with the following data flow:
                    <br><br>
                    <div style="font-family: monospace; background: rgba(255,255,255,0.8); padding: 15px; border-radius: 8px; margin: 10px 0;">
                        Browser ‚Üí API Gateway ‚Üí Lambda ‚Üí Amazon ElastiCache Serverless for Valkey 8.1
                    </div>
                    <strong>üîê Security:</strong> TLS encryption, VPC isolation, and proper CORS configuration ensure secure data transmission. All scores are capped at 1000 points and persist in the real Valkey cluster.
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'YOUR_API_GATEWAY_URL_HERE'; // Replace with your API Gateway URL
        let debugLog = [];
        let usingProxy = false;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLog.push(logEntry);
            console.log(logEntry);
            
            // Keep only last 50 log entries
            if (debugLog.length > 50) {
                debugLog.shift();
            }
        }

        function setStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 8000);
        }

        // Try direct API Gateway first, then fallback to proxy
        async function apiRequest(endpoint, options = {}) {
            const url = API_URL + endpoint;
            log(`Making ${options.method || 'GET'} request to ${endpoint}`);

            try {
                // Try direct API Gateway connection first
                log('üéØ Attempting direct API Gateway connection...');
                const response = await fetch(url, {
                    method: options.method || 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    body: options.body ? JSON.stringify(options.body) : undefined
                });

                log(`Direct response status: ${response.status}`);

                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Direct API Gateway connection successful!');
                    if (usingProxy) {
                        usingProxy = false;
                        log('üéØ Switched back to direct connection');
                    }
                    return data;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (directError) {
                log(`‚ùå Direct connection failed: ${directError.message}`);

                // Fallback to CORS proxy
                return await proxyRequest(endpoint, options);
            }
        }

        // CORS proxy fallback
        async function proxyRequest(endpoint, options = {}) {
            log('üîÑ Falling back to CORS proxy...');
            usingProxy = true;

            try {
                if (options.method === 'POST') {
                    // For POST requests, try cors-anywhere first
                    const proxyUrl = `https://cors-anywhere.herokuapp.com/${API_URL}${endpoint}`;
                    log(`Using CORS proxy: ${proxyUrl}`);
                    
                    const response = await fetch(proxyUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify(options.body)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        log('‚úÖ CORS proxy POST successful');
                        return data;
                    } else {
                        throw new Error(`Proxy error: ${response.status}`);
                    }
                } else {
                    // For GET requests, use allorigins
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(API_URL + endpoint)}`;
                    log(`Using GET proxy: ${proxyUrl}`);
                    
                    const response = await fetch(proxyUrl);
                    if (response.ok) {
                        const data = await response.json();
                        log('‚úÖ CORS proxy GET successful');
                        return data;
                    } else {
                        throw new Error(`Proxy error: ${response.status}`);
                    }
                }
            } catch (proxyError) {
                log(`‚ùå CORS proxy also failed: ${proxyError.message}`);
                throw new Error('Both direct and proxy connections failed');
            }
        }

        async function testHealth() {
            setStatus('üîÑ Testing connection to Valkey...', 'loading');
            try {
                const data = await apiRequest('/health');
                if (data && data.success && data.ping === 'PONG') {
                    const connectionType = usingProxy ? 'via CORS proxy' : 'directly';
                    setStatus(`‚úÖ Connected to Valkey Serverless ${connectionType}! Ping: ${data.ping}`, 'success');
                    return true;
                } else {
                    setStatus('‚ùå Unexpected response from Valkey', 'error');
                    return false;
                }
            } catch (error) {
                setStatus(`‚ùå Connection failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function loadLeaderboard() {
            setStatus('üîÑ Loading leaderboard from Valkey...', 'loading');
            try {
                const data = await apiRequest('/leaderboard');
                if (data && data.leaderboard) {
                    displayLeaderboard(data.leaderboard);
                    updateStats(data.leaderboard);
                    const connectionType = usingProxy ? 'via proxy' : 'directly';
                    setStatus(`‚úÖ Loaded ${data.leaderboard.length} players ${connectionType}`, 'success');
                } else {
                    throw new Error('Invalid leaderboard data');
                }
            } catch (error) {
                setStatus(`‚ùå Failed to load leaderboard: ${error.message}`, 'error');
            }
        }

        function displayLeaderboard(players) {
            const leaderboard = document.getElementById('leaderboard');
            
            if (players.length === 0) {
                leaderboard.innerHTML = '<li class="message info">No players yet. Be the first to add your score!</li>';
                return;
            }
            
            leaderboard.innerHTML = players.map((player, index) => `
                <li class="leaderboard-item">
                    <span class="rank">#${index + 1}</span>
                    <span class="player-name">${player.player}</span>
                    <span class="score">${player.score.toLocaleString()}</span>
                </li>
            `).join('');
        }

        function updateStats(players) {
            if (players.length === 0) return;
            
            const totalPlayers = players.length;
            const highestScore = Math.max(...players.map(p => p.score));
            const averageScore = Math.round(players.reduce((sum, p) => sum + p.score, 0) / totalPlayers);
            
            const statsHtml = `
                <div class="stat-item">
                    <div class="stat-value">${totalPlayers}</div>
                    <div class="stat-label">Total Players</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${highestScore.toLocaleString()}</div>
                    <div class="stat-label">Highest Score</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${averageScore.toLocaleString()}</div>
                    <div class="stat-label">Average Score</div>
                </div>
            `;
            
            document.getElementById('stats').innerHTML = statsHtml;
        }

        async function addScore(name, score) {
            const btn = document.getElementById('addScoreBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Adding...';
            
            setStatus('üîÑ Adding score to Valkey...', 'loading');

            try {
                // Cap score at 1000
                if (score > 1000) {
                    score = 1000;
                    showMessage('scoreMessage', '‚ö†Ô∏è Score capped at maximum 1000 points', 'warning');
                }

                const data = await apiRequest('/score', {
                    method: 'POST',
                    body: { player: name, score: score }
                });

                if (data && data.success) {
                    const connectionType = usingProxy ? 'via proxy' : 'directly';
                    showMessage('scoreMessage', `‚úÖ ${data.message} (${connectionType})`, 'success');
                    setStatus(`‚úÖ Score added successfully ${connectionType}!`, 'success');

                    // Clear form
                    document.getElementById('playerName').value = '';
                    document.getElementById('playerScore').value = '';

                    // Refresh leaderboard
                    setTimeout(() => loadLeaderboard(), 1000);
                } else {
                    throw new Error(data?.message || 'Unknown error');
                }
            } catch (error) {
                showMessage('scoreMessage', `‚ùå Error: ${error.message}`, 'error');
                setStatus(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Add Score Directly';
            }
        }

        // Form submission with score capping
        document.getElementById('scoreForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const playerName = document.getElementById('playerName').value.trim();
            let playerScore = parseInt(document.getElementById('playerScore').value);
            
            if (!playerName || isNaN(playerScore) || playerScore < 0) {
                showMessage('scoreMessage', '‚ùå Please enter valid player name and score', 'error');
                return;
            }
            
            await addScore(playerName, playerScore);
        });

        // Real-time score validation
        document.getElementById('playerScore').addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            if (value > 1000) {
                e.target.value = 1000;
                showMessage('scoreMessage', '‚ö†Ô∏è Maximum score is 1000 points', 'warning');
            }
        });

        // Initialize the app
        window.addEventListener('load', async () => {
            log('üöÄ Valkey Serverless Leaderboard starting with direct API Gateway...');

            // Test connection and load leaderboard
            const healthOk = await testHealth();
            if (healthOk) {
                await loadLeaderboard();
            }
        });
    </script>
</body>
</html>
